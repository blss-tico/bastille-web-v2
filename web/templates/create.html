{{define "content"}}
  <div class="card">
    {{$parentContext := .}}
    {{range .Data.Commands}}
      {{if eq .Command $.CommandName}}
        <header>{{.Command}} <span id="hostName"></span> </header>
        <br>
        <form id="{{$.CommandName}}-form" class="card-form">
          <fieldset>
            {{range .Fields}}
              {{if or (eq . "GTWIP") (eq . "IPIP") (eq . "VALUE") (eq . "VLANID") (eq . "zfsoptions")}}                
                <input type="text" placeholder="{{.}}" name="{{.}}" id="{{.}}" class="input-text"
                aria-describedby="invalid-{{.}}" />
                <small id="invalid-{{.}}"></small>
              {{else}}
                <input type="text" placeholder="{{.}}" name="{{.}}" id="{{.}}" class="input-text"
                aria-describedby="invalid-{{.}}" />
                <small id="invalid-{{.}}"></small>
              {{end}}    
            {{end}}
          </fieldset>
          <fieldset>
            <legend>OPTIONS</legend>
            <div class="create-form-options">
              {{range $index, $element := .Options}}
                <label for="options_{{$element.Lflag}}">
                  <input type="checkbox" name="options_{{$element.Lflag}}" value="{{$element.Sflag}}" onchange="handleCheckBox(this)" />
                  {{$element.Lflag}}
                </label>                
              {{end}}
            </div>
          </fieldset>
          <div class="grid">
            <button id="submitBtn" class="secondary btn-card-submit" onclick="createSubmit(event)">Submit</button>
            <button class="primary btn-card-help" onclick="helpED(event)">Help</button>
            <button class="outline contrast" onclick="backToHome(event)">Home</button>
          </div>
        </form>
        <br>
        <div class="card-footer">
          <div class="card-help" id="card-help">
            <h3>Help</h3>
            <small class="secondary">{{.Description}}</small>
            <br><br>
            <p>{{.Help}}</p>
            <div class="card-help-options">
              {{range .Options}}
                <p>&nbsp;&nbsp;{{.Sflag}}&nbsp;|&nbsp;{{.Lflag}}&nbsp;-&nbsp;{{.Text}}</p>
              {{end}}
            </div>
          </div>
          <br>
          <div class="card-results">
            <p id="result" class="card-result"></p>
            <p id="error" class="card-error"></p>
          </div>
        </div>
      {{end}}
    {{end}}
  </div>

  <script>
    let hlp = document.getElementById("card-help");
    hlp.style.display = 'none';

    let hostName = document.getElementById('hostName');
    hostName.innerHTML = `[${sessionStorage.getItem('hostname')}]`;

    function helpED(event) {
      event.preventDefault();     
      hlp.style.display === 'none' ?  hlp.style.display = 'block' : hlp.style.display = 'none';
    }

    const enabled = '1px solid #8f8f9d';
    const disabled = '1px solid #ccc';

    let gi = document.getElementById("GTWIP");
    gi.style.border = disabled;
    gi.disabled = true;
    gi.style.display = 'none';

    let ii = document.getElementById("IPIP");
    ii.style.border = disabled;
    ii.disabled = true;
    ii.style.display = 'none';

    let vl = document.getElementById("VALUE");
    vl.style.border = disabled;
    vl.disabled = true;
    vl.style.display = 'none';

    let vi = document.getElementById("VLANID");
    vi.style.border = disabled;
    vi.disabled = true;
    vi.style.display = 'none';

    let zo = document.getElementById("zfsoptions");
    zo.style.border = disabled;
    zo.disabled = true;
    zo.style.display = 'none';

    function handleCheckBox(check) {
      if (check.value === "-g" || check.value === '--gateway') {
        if (check.checked) {
          gi.style.border = enabled;
          gi.disabled = false;
          gi.style.display = 'block';
          return;
        } else {
          gi.style.border = disabled;
          gi.disabled = true; 
          gi.style.display = 'none';
          return;
        }
      }

      if (check.value === "-n" || check.value === '--nameserver') {
        if (check.checked) {
          ii.style.border = enabled;
          ii.disabled = false;
          ii.style.display = 'block';
          return;
        } else {
          ii.style.border = disabled;
          ii.disabled = true;
          ii.style.display = 'none';
          return;
        }
      }

      if (check.value === "-p" || check.value === '--priority') { 
        if (check.checked) {
          vl.style.border = enabled;
          vl.disabled = false; 
          vl.style.display = 'block';
          return;
        } else {
          vl.style.border = disabled;
          vl.disabled = true; 
          vl.style.display = 'none';
          return;
        }
      }

      if (check.value === "-v" || check.value === '--vlan') { 
        if (check.checked) {
          vi.style.border = enabled;
          vi.disabled = false; 
          vi.style.display = 'block';
          return;
        } else {
          vi.style.border = disabled;
          vi.disabled = true; 
          vi.style.display = 'none';
          return;
        }
      }

      if (check.value === "-Z" || check.value === '--zfs-opts') { 
        if (check.checked) {
          zo.style.border = enabled;
          zo.disabled = false; 
          zo.style.display = 'block';
          return;
        } else {
          zo.style.border = disabled;
          zo.disabled = true;
          zo.style.display = 'none';
          return;
        }
      }
    }

    function backToHome(event) {
      event.preventDefault();

      const ipaddr = sessionStorage.getItem('ipaddr');
      const port = sessionStorage.getItem('port');
      window.location.href = `http://${ipaddr}:${port}/home`;
    }

    async function createSubmit(event) {
      event.preventDefault();

      const name = '{{$.CommandName}}';
      const result = document.getElementById('result');
      const error = document.getElementById('error');
      result.innerText = "";
      error.innerText = ""; 

      const form = document.getElementById(name + '-form');
      const formData = new FormData(form);      
      let options = [];
      let formObj = {};
      const ipv4Regex = /^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)$/;
      const ipv4WithCidrRegex = /^((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\/(3[0-2]|[12]?\d))?$/;
      const ipv6Regex = /^((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?$/;
      const someOptions = ["-B", "-C", "-D", "-E", "-L", "-M", "--no-validate", "--no-boot", "-T", "-V", "-x"];
      
      formData.forEach((value, key) => {
        if (key.indexOf('options_') != -1) {
          if (someOptions.includes(value)) {
            options.push(value);
            return;
          }
        }

        value = value.trim();

        if (key === "GTWIP") {        
          gi.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (ipv4Regex.test(value) || ipv6Regex.test(value)) {
            gi.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: GTWIP is a required field and must to be valid ip number.";
          error.innerText = errorString;
          gi.style.borderColor = '#e72727';
          gi.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "IPIP") {          
          ii.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          let arrIPIP = value.split(",");
          let validIPIP = true;
          if (arrIPIP.length > 0) {
            for (let i=0; i<arrIPIP.length; i++) {
              const v = arrIPIP[i].trim();
              if (!ipv4Regex.test(v) && !ipv6Regex.test(v)) {
                validIPIP = false;
                break;
              }
            }
            
            if (validIPIP) {
              ii.setAttribute('aria-invalid', 'false');
              formObj[key] = value;
              return;
            }
          } else {
            if (ipv4Regex.test(value) || ipv6Regex.test(value)) {
              ii.setAttribute('aria-invalid', 'false');
              formObj[key] = value;
              return;
            }
          }

          let errorString = "[Error]: IP,IP is a required field and must to be valid ip number.";
          error.innerText = errorString;
          ii.style.borderColor = '#e72727';
          ii.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "VALUE") {          
          vl.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            vl.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: VALUE is a required field.";
          error.innerText = errorString;
          vl.style.borderColor = '#e72727';
          vl.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "VLANID") {          
          vi.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            vi.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: VLANID is a required field.";
          error.innerText = errorString;
          vi.style.borderColor = '#e72727';
          vi.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "zfsoptions") {          
          zo.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            zo.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: zfsoptions is a required field.";
          error.innerText = errorString;
          zo.style.borderColor = '#e72727';
          zo.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "NAME") {
          let n = document.getElementById(key);
          n.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            n.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: NAME is a required field.";
          error.innerText = errorString;
          n.style.borderColor = '#e72727';
          n.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "RELEASE") {
          let r = document.getElementById(key);
          r.style.border = enabled;

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            r.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: RELEASE is a required field.";
          error.innerText = errorString;
          r.style.borderColor = '#e72727';
          r.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "IP") {
          let i = document.getElementById(key);
          i.style.border = enabled;
          
          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (ipv4Regex.test(value) || ipv4WithCidrRegex.test(value) || ipv6Regex.test(value)) {
            i.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: IP is a required field and must to a valid ip number.";
          error.innerText = errorString;
          i.style.borderColor = '#e72727';
          i.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }

        if (key === "INTERFACE") {
          if (value != "") {
            formObj[key] = value;
            return;
          }
        }        
      });

      if (error.innerText != "") { return; }

      formObj['options'] = options.join(' ').trimEnd();
      const formJson = JSON.stringify(formObj);
      console.log(formJson);

      result.innerText = 'send -> bastille ' + name;

      const response = await sendHttpRequest(name, formJson);
      if (response.code == 200) {
        error.innerText = "";
        result.innerText = response.data.msg;
      } else {
        result.innerText = "";
        error.innerText = response.error;
      }
    }
  </script>
{{end}}
