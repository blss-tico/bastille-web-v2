{{define "content"}}
  <div class="card">
    {{$parentContext := .}}
    {{range .Data.Commands}}
      {{if eq .Command $.CommandName}}
        <header>{{.Command}} <span id="hostName"></span> </header>
        <br>
        <form id="{{$.CommandName}}-form" class="card-form">
          <fieldset>
            {{range .Fields}}              
              {{if eq . "TARGET"}}
                <select name="{{.}}" id="{{.}}" aria-label="{{.}}" required></select>
                <small id="invalid-{{.}}"></small>            
              {{end}}
            {{end}}
          </fieldset>
          <fieldset>
            <div class="create-form-options">
              {{range .Fields}}
                {{if and (ne . "TARGET") (ne . "OPTION") (ne . "VALUE")}}                      
                  <fieldset>                  
                    <label>      
                      <input type="radio" id="{{.}}" name="action" value="{{.}}" onchange="handleRadioBtn(this)" />
                      {{.}}
                    </label>                
                  </fieldset>
                {{end}}
              {{end}}
            </div>
          </fieldset>
          <fieldset>
            {{range .Fields}}
              {{if or (eq . "OPTION") (eq . "VALUE")}}                
                <input type="text" placeholder="{{.}}" name="{{.}}" id="{{.}}" class="input-text"
                  aria-describedby="invalid-{{.}}" />
                <small id="invalid-{{.}}"></small>
              {{end}}              
            {{end}}
          </fieldset>
          <fieldset>
            <legend>Options</legend>
            {{range .Options}}
              <input type="checkbox" name="options_{{.Lflag}}" value="{{.Sflag}}" role="switch" />{{.Lflag}}&nbsp;
            {{end}}
          </fieldset>
          <div class="grid">
            <button id="submitBtn" class="secondary btn-card-submit" onclick="limitsSubmit(event)">Submit</button>
            <button class="primary btn-card-help" onclick="helpED(event)">Help</button>
            <button class="outline contrast" onclick="backToHome(event)">Home</button>
          </div>
        </form>
        <br>
        <div class="card-footer">
          <div class="card-help" id="card-help">
            <h3>Help</h3>
            <small class="secondary">{{.Description}}</small>
            <br><br>
            <p>{{.Help}}</p>
            <div class="card-help-options">
              {{range .Options}}
                <p>&nbsp;&nbsp;{{.Sflag}}&nbsp;|&nbsp;{{.Lflag}}&nbsp;-&nbsp;{{.Text}}</p>
              {{end}}
              <h4>OPTION FIELD (possible values)</h4>
              <ul>
                <li>cputime, datasize, stacksize, coredumpsize, memoryuse;</li>
                <li>memorylocked, maxproc, openfiles, vmemoryuse, pseudoterminals;</li>
                <li>swapuse, nthr, msgqqueued, msgqsize, nmsgq;</li>
                <li>nsemop, nshm, shmsize, wallclock, pcpu;</li>
                <li>readbps, writebps, readiops, writeiops;</li>         
              </ul>
            </div>
          </div>
          <br>
          <div class="card-results">
            <p id="result" class="card-result"></p>
            <p id="error" class="card-error"></p>
          </div>
        </div>
      {{end}}
    {{end}}
  </div>

  <script>
    let hlp = document.getElementById("card-help");
    hlp.style.display = 'none';

    let hostName = document.getElementById('hostName');
    hostName.innerHTML = `[${sessionStorage.getItem('hostname')}]`;

    let optionfieldError;
    let valuefieldError;

    let tgt = document.getElementById('TARGET');
    let jails = sessionStorage.getItem('jails');
    let pjails = JSON.parse(jails);
    pjails.forEach(j => {
      const option = document.createElement("option");
      option.value = j.Hostname;
      option.textContent = j.Hostname;
      tgt.appendChild(option);
    });

    function helpED(event) {
      event.preventDefault();     
      hlp.style.display === 'none' ?  hlp.style.display = 'block' : hlp.style.display = 'none';
    }

    let optional = false;

    function handleRadioBtn(radio) {
      const initialBorder = '1px solid #8f8f9d';
      const disabledBorder = '1px solid #ccc';

      let o = document.getElementById("OPTION");
      o.style.border = initialBorder;
      o.disabled = false;

      let v = document.getElementById("VALUE");
      v.style.border = initialBorder;
      v.disabled = false;
      
      if (radio.value === 'clear' || radio.value === 'reset' || radio.value === 'stats') { 
        o.setAttribute('aria-invalid', 'false');
        if (optionfieldError) { optionfieldError.innerHTML = ""; }
        o.style.border = disabledBorder;
        o.disabled = true;
        
        v.setAttribute('aria-invalid', 'false');
        if (valuefieldError) { valuefieldError.innerHTML = ""; }
        v.style.border = disabledBorder;
        v.disabled = true; 
        return;
      }

      if (radio.value === 'remove' || radio.value === 'active') {
        v.setAttribute('aria-invalid', 'false');
        if (valuefieldError) { valuefieldError.innerHTML = ""; }
        v.style.border = disabledBorder;
        v.disabled = true; 
        return;
      }

      if (radio.value === 'list' || radio.value === 'show') {
        v.setAttribute('aria-invalid', 'false');
        if (valuefieldError) { valuefieldError.innerHTML = ""; }
        v.style.border = disabledBorder;        
        v.disabled = true; 
        optional = true;
        return;
      }
    }

    function backToHome(event) {
      event.preventDefault();

      const ipaddr = sessionStorage.getItem('ipaddr');
      const port = sessionStorage.getItem('port');
      window.location.href = `http://${ipaddr}:${port}/home`;
    }

    async function limitsSubmit(event) {
      event.preventDefault();

      const name = '{{$.CommandName}}';
      const result = document.getElementById('result');
      const error = document.getElementById('error');
      result.innerText = "";
      error.innerText = ""; 

      const form = document.getElementById(name + '-form');
      const formData = new FormData(form);      
      let options = [];
      let formObj = {};
      formData.forEach((value, key) => {
        if (key.indexOf('options_') != -1) {
          options.push(value);
          return;
        }

        value = value.trim();

        if (key === "action") {
          formObj[key] = value;
          return;
        }

        if (key === "TARGET") {
          let sj = document.getElementById(key);
          sj.style.borderColor = 'initial';

          let fieldError = document.getElementById(`invalid-${key}`);
          fieldError.innerHTML = "";

          if (value != "") {
            sj.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: TARGET is a required field.";
          error.innerText = errorString;
          sj.style.borderColor = '#e72727';
          sj.setAttribute('aria-invalid', 'true');
          fieldError.innerHTML = errorString;
        }
        
        if (key === "OPTION") {
          let o = document.getElementById(key);
          o.style.borderColor = 'initial';

          optionfieldError = document.getElementById(`invalid-${key}`);
          optionfieldError.innerHTML = "";

          if (value != "" || optional) {
            o.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: OPTION is a required field.";
          error.innerText = errorString;
          o.style.borderColor = '#e72727';
          o.setAttribute('aria-invalid', 'true');
          optionfieldError.innerHTML = errorString;
        }

        if (key === "VALUE") {
          console.log("value: ", key);

          let v = document.getElementById(key);
          v.style.borderColor = 'initial';

          valuefieldError = document.getElementById(`invalid-${key}`);
          valuefieldError.innerHTML = "";

          if (value != "") {
            v.setAttribute('aria-invalid', 'false');
            formObj[key] = value;
            return;
          }

          let errorString = "[Error]: VALUE is a required field.";
          error.innerText = errorString;
          v.style.borderColor = '#e72727';
          v.setAttribute('aria-invalid', 'true');
          valuefieldError.innerHTML = errorString;
        }
      });

      if (error.innerText != "") { return; }

      formObj['options'] = options.join(' ').trimEnd();
      const formJson = JSON.stringify(formObj);

      result.innerText = 'send -> bastille ' + name;

      let submitBtn = document.getElementById('submitBtn');
      submitBtn.classList.add('loading');
      submitBtn.innerHTML = '<span class="spinner"></span>';

      const response = await sendHttpRequest(name, formJson);
      if (response.code == 200) {
        error.innerText = "";
        result.innerText = response.data.msg;
      } else {
        result.innerText = "";
        error.innerText = response.error;
      }

      submitBtn.classList.remove('loading');
      submitBtn.innerHTML = 'Submit';
    }
  </script>
{{end}}
